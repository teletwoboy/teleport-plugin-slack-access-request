name: Delete Branch on Issue Closed

on:
  issues:
    types: [closed]

jobs:
  delete-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Determine branch name
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          CATEGORY=$(echo "$ISSUE_BODY" \
          | grep -i '^üìÅ Category' -A 1 \
          | tail -n 1 \
          | sed -E 's/\s*\(.*\)//' \
          | tr '[:upper:]' '[:lower:]' \
          | xargs)
          CATEGORY=${CATEGORY:-chore}

          SLUG=$(echo "$ISSUE_TITLE" \
            | sed -E 's/^\[[^]]+\]\s*//' \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g' \
            | sed -E 's/^-+|-+$//g')

          BRANCH_NAME="${CATEGORY}/#${ISSUE_NUMBER}/${SLUG}"
          echo "üóë Deleting branch: $BRANCH_NAME"

          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
        
          git fetch origin
          git push origin --delete "$BRANCH_NAME" || echo "‚ö†Ô∏è Branch not found or already deleted."